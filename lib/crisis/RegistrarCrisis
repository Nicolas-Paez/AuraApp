import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import 'package:hive/hive.dart';
import 'package:aura3/models/Crisis.dart';
import 'HistorialCrisis';

class PantallaRegistrarCrisis extends StatefulWidget {
  const PantallaRegistrarCrisis({super.key});

  @override
  State<PantallaRegistrarCrisis> createState() => _PantallaRegistrarCrisisState();
}

class _PantallaRegistrarCrisisState extends State<PantallaRegistrarCrisis> {
  DateTime fechaHora = DateTime.now();

  // Registro r√°pido
  String? duracion;
  String? consciente;
  String? medicamentoRescate;

  // Detalles opcionales
  String? preictal;
  String? ictal;
  String? medicacionEmergencia;
  String? postictalSentimiento;
  String? postictalTiempoRecuperacion;

  // Escala Likert
  int? estadoAnimoAntes;
  int? estadoAnimoDespues;

  bool rapidoExpanded = true;
  bool opcionalesExpanded = false;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color(0xFFF7F8FA),
      appBar: AppBar(
        elevation: 0,
        backgroundColor: Colors.white,
        foregroundColor: const Color(0xFF1E3A8A),
        title: const Text(
          'Registrar Crisis',
          style: TextStyle(
            fontWeight: FontWeight.bold,
            color: Color(0xFF1E3A8A),
          ),
        ),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _buildSectionTitle('¬øCu√°nto tiempo dur√≥ la crisis? *'),
            _buildOptionCards(
              groupValue: duracion,
              onSelected: (val) => setState(() => duracion = val),
              options: [
                'Menos de 1 minuto',
                'Entre 3 a 5 minutos',
                'M√°s de 5 minutos',
                'No lo recuerdo',
              ],
            ),
            const SizedBox(height: 20),

            _buildSectionTitle('¬øEstabas consciente? *'),
            _buildOptionCards(
              groupValue: consciente,
              onSelected: (val) => setState(() => consciente = val),
              options: ['S√≠', 'No', 'No lo s√©'],
            ),
            const SizedBox(height: 20),

            _buildSectionTitle('¬øSe us√≥ medicaci√≥n de rescate? *'),
            _buildOptionCards(
              groupValue: medicamentoRescate,
              onSelected: (val) => setState(() => medicamentoRescate = val),
              options: ['S√≠', 'No'],
            ),
            const SizedBox(height: 20),

            // Fecha y hora
            _buildDateTimePicker(),
            const SizedBox(height: 32),

            // Detalles opcionales
            ExpansionTile(
              title: const Text(
                'DETALLES ADICIONALES',
                style: TextStyle(
                    fontWeight: FontWeight.bold, color: Color(0xFF1E3A8A)),
              ),
              childrenPadding: const EdgeInsets.all(12),
              iconColor: const Color(0xFF1E3A8A),
              collapsedIconColor: const Color(0xFF1E3A8A),
              children: [
                _buildSectionTitle('¬øC√≥mo empez√≥ la crisis?'),
                _buildTextInput(
                  label: 'Describe brevemente (opcional)',
                  onChanged: (val) => preictal = val,
                ),
                const SizedBox(height: 20),
                _buildSectionTitle('Durante la crisis (Ictal)'),
                _buildDropdown(
                  label: '¬øQu√© sucedi√≥?',
                  value: ictal,
                  options: [
                    'Movimientos fuertes o sacudidas',
                    'Se qued√≥ r√≠gido',
                    'Se cay√≥ o perdi√≥ fuerza',
                    'Movimientos repetitivos',
                    'No respondi√≥ / parec√≠a desconectado',
                  ],
                  onChanged: (val) => setState(() => ictal = val),
                ),
                const SizedBox(height: 20),
                _buildSectionTitle('Estado an√≠mico antes y despu√©s'),
                const SizedBox(height: 8),
                const Text('Antes de la crisis:'),
                _buildLikertSelector(
                  selected: estadoAnimoAntes,
                  onSelected: (val) => setState(() => estadoAnimoAntes = val),
                ),
                const SizedBox(height: 12),
                const Text('Despu√©s de la crisis:'),
                _buildLikertSelector(
                  selected: estadoAnimoDespues,
                  onSelected: (val) => setState(() => estadoAnimoDespues = val),
                ),
                const SizedBox(height: 16),
              ],
            ),

            const SizedBox(height: 32),
            Center(
              child: ElevatedButton.icon(
                icon: const Icon(Icons.bolt_rounded, color: Colors.white),
                onPressed: _guardarCrisis,
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFF1E3A8A),
                  padding: const EdgeInsets.symmetric(
                      vertical: 16, horizontal: 40),
                  shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(14)),
                  elevation: 5,
                ),
                label: const Text(
                  'Guardar Registro',
                  style: TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 18),
                ),
              ),
            ),
            const SizedBox(height: 40),
          ],
        ),
      ),
    );
  }

  // --------- Secciones visuales personalizadas ----------

  Widget _buildSectionTitle(String text) {
    return Text(
      text,
      style: const TextStyle(
        fontSize: 17,
        fontWeight: FontWeight.w600,
        color: Color(0xFF1E3A8A),
      ),
    );
  }

  Widget _buildOptionCards({
    required String? groupValue,
    required Function(String) onSelected,
    required List<String> options,
  }) {
    return Wrap(
      spacing: 10,
      runSpacing: 10,
      children: options.map((opt) {
        final selected = groupValue == opt;
        return GestureDetector(
          onTap: () => onSelected(opt),
          child: AnimatedContainer(
            duration: const Duration(milliseconds: 200),
            padding: const EdgeInsets.symmetric(vertical: 14, horizontal: 18),
            decoration: BoxDecoration(
              color: selected ? const Color(0xFF1E3A8A) : Colors.white,
              borderRadius: BorderRadius.circular(14),
              border: Border.all(
                color: selected
                    ? const Color(0xFF1E3A8A)
                    : Colors.grey.withOpacity(0.3),
              ),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.05),
                  blurRadius: 6,
                  offset: const Offset(0, 3),
                ),
              ],
            ),
            child: Text(
              opt,
              style: TextStyle(
                color: selected ? Colors.white : Colors.black87,
                fontWeight: FontWeight.w500,
              ),
            ),
          ),
        );
      }).toList(),
    );
  }

  Widget _buildTextInput({
    required String label,
    required ValueChanged<String> onChanged,
  }) {
    return TextField(
      onChanged: onChanged,
      maxLines: 2,
      decoration: InputDecoration(
        hintText: label,
        filled: true,
        fillColor: Colors.grey.shade100,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide.none,
        ),
      ),
    );
  }

  Widget _buildDropdown({
    required String label,
    required String? value,
    required List<String> options,
    required ValueChanged<String?> onChanged,
  }) {
    return DropdownButtonFormField<String>(
      value: value,
      isExpanded: true,
      decoration: InputDecoration(
        labelText: label,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide.none,
        ),
        filled: true,
        fillColor: Colors.grey.shade100,
      ),
      items: options
          .map((opt) => DropdownMenuItem(
                value: opt,
                child: Text(opt),
              ))
          .toList(),
      onChanged: onChanged,
    );
  }

  Widget _buildDateTimePicker() {
    return InkWell(
      onTap: () async {
        final pickedDate = await showDatePicker(
          context: context,
          initialDate: fechaHora,
          firstDate: DateTime(2000),
          lastDate: DateTime(2100),
        );
        if (pickedDate != null) {
          final pickedTime = await showTimePicker(
            context: context,
            initialTime: TimeOfDay.fromDateTime(fechaHora),
          );
          if (pickedTime != null) {
            setState(() {
              fechaHora = DateTime(
                pickedDate.year,
                pickedDate.month,
                pickedDate.day,
                pickedTime.hour,
                pickedTime.minute,
              );
            });
          }
        }
      },
      child: Container(
        width: double.infinity,
        padding: const EdgeInsets.symmetric(vertical: 14, horizontal: 18),
        decoration: BoxDecoration(
          color: Colors.grey.shade100,
          borderRadius: BorderRadius.circular(14),
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Flexible(
              child: Text(
                'Fecha y hora: ${DateFormat('dd/MM/yyyy HH:mm').format(fechaHora)}',
                style: const TextStyle(color: Colors.black87),
              ),
            ),
            const Icon(Icons.calendar_today_rounded,
                color: Color(0xFF1E3A8A)),
          ],
        ),
      ),
    );
  }

  Widget _buildLikertSelector({
    required int? selected,
    required ValueChanged<int> onSelected,
  }) {
    final emotions = ['üò¢', 'üòê', 'üòä'];
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceEvenly,
      children: List.generate(3, (index) {
        final isSelected = selected == index;
        return GestureDetector(
          onTap: () => onSelected(index),
          child: AnimatedContainer(
            duration: const Duration(milliseconds: 150),
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color:
                  isSelected ? const Color(0xFF1E3A8A).withOpacity(0.2) : Colors.white,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(
                color:
                    isSelected ? const Color(0xFF1E3A8A) : Colors.grey.shade300,
              ),
            ),
            child: Text(
              emotions[index],
              style: const TextStyle(fontSize: 28),
            ),
          ),
        );
      }),
    );
  }

  void _guardarCrisis() async {
    if (duracion == null || consciente == null || medicamentoRescate == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content:
              Text('Por favor completa el registro r√°pido antes de guardar'),
        ),
      );
      return;
    }

    final box = Hive.box<Crisis>('crisisBox');
    final nuevaCrisis = Crisis(
      fechaHora: fechaHora,
      duracion: duracion!,
      consciente: consciente!,
      medicamentoRescate: medicamentoRescate!,
      preictal: preictal,
      ictal: ictal,
      medicacionEmergencia: medicacionEmergencia,
      postictalSentimiento: postictalSentimiento,
      postictalTiempoRecuperacion: postictalTiempoRecuperacion,
      estadoAnimoAntes: estadoAnimoAntes,
      estadoAnimoDespues: estadoAnimoDespues,
    );

    await box.add(nuevaCrisis);
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('Crisis registrada exitosamente')),
    );

    Navigator.pushReplacement(
      context,
      MaterialPageRoute(builder: (_) => const HistorialCrisisScreen()),
    );
  }
}
